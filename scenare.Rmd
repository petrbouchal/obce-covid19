---
title: "Scénáře dopadu krize na finance obcí a měst"
output:
  html_document:
    toc: no
---

```{r setup, include=FALSE}
library(tidyverse)
library(ptrr)
library(Hmisc)
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE,
                      include = FALSE)
```

```{r metadata}
source("shared.R")
```

```{r geom-defaults}
ggplot2::update_geom_defaults(geom = "bar",
                              new = list(fill = "darkblue"))
ggplot2::update_geom_defaults(geom = "col",
                              new = list(fill = "darkblue"))
ggplot2::update_geom_defaults(geom = "point",
                              new = list(fill = "darkblue",
                                         colour = "darkblue"))
ggplot2::update_geom_defaults(geom = "line",
                              new = list(colour = "darkblue"))
```


```{r data-load}
indikatory <- read_rds("data-processed/scenare_vysledky.rds") %>% 
  mutate(typobce = as.factor(typobce) %>% 
           fct_relevel(c("Krajské město/Praha",
                         "S rozšířenou působností",
                         "S pověřeným OÚ",
                         "běžná obec")) %>% 
           fct_recode(`Běžná obec` = "běžná obec"),
         kraj_short = fct_relabel(kraj,
                                  ~str_remove(.x, "\\s?Kraj\\s?")) %>% 
           fct_recode(`Praha` = "Hlavní Město Praha"))
scenarios <- read_rds("data-processed/scenarios.rds")
scenarios_by_year <- read_rds("data-processed/scenarios_by_year.rds")
```

```{r scens}
sc_real <- c("R20-D0-debt",
             "R20-D0-res",
             "R20-D0-mix")
sc_real_mid <- "R20-D0-mix"
sc_opt <- c("R10-D0-mix")
sc_pes <- c("R30-D0-mix")

sc_base <- c("R0", "R")

sc_all <- c(sc_real, sc_opt, sc_pes)
```


```{r data-subset}
indik_2019 <- indikatory %>% 
  filter(per_yr == 2019)

iscn <- indikatory %>% 
  filter(per_yr %in% 2019:2020)
```



[Word dokument ke komentování](scenare.docx)

# {.tabset .tabset-pills}

## *Úvod ke scénářům* 

### Scénáře a předpoklady

Pro rok 2020 ukazujeme pokles hlavního zdroje příjmů, rozpočtového určení daní, ve třech základních scénářích poklesu příjmů, které obohacujeme o dvě varianty dopadu na zadlužení obcí.

#### Pokles příjmů z RUD 

U dopadu krize na příjmy z RUD uvažujeme varianty s poklesem příjmů o

-	10 % (optimistický scénář), 
- 20 % (realistický scénář),
-	30 % (pesimistický scénář).

Při vytváření těchto scénářů vycházíme z odhadů vývoje ekonomiky a daňových příjmů v roce 2020. Například Ministerstvo financí v dubnu [prognózovalo propad HDP o 5,6 %](https://www.mfcr.cz/cs/verejny-sektor/makroekonomika/makroekonomicka-predikce/2020/makroekonomicka-predikce-duben-2020-38089) a z následné [daňová predikce ze 7. května](https://www.mfcr.cz/cs/verejny-sektor/uzemni-rozpocty/prijmy-kraju-a-obci/zakladni-informace/2020/aktualizovana-danova-predikce-pro-usc--d-38300) očekávalo propad daňových příjmů obcí o cca 11 %. Ze 13 odborných institucí zapojených v [šetření prognóz makroekonomického vývoje](https://www.mfcr.cz/cs/verejny-sektor/makroekonomika/makroekonomicka-predikce/2020/49-kolokvium--setreni-prognoz-makroekono-38442) Ministerstva financí je pokles HDP právě o 5,6 % ten nejnižší, o 7,6 % v průměru a o 11,0 % nejvyšší.

Další důvod, proč je možné dřívější daňovou predikci Ministerstva financí považovat za optimistický scénář, je to, že nezahrnuje případný obcím nekompenzovaný pokles příjmů obcí spojených kompenzačním bonusem OSVČ a společníky malých s.r.o. (který by pro obce mohl znamenat o cca 9 miliard a tedy cca 4 % nižší daňové příjmy). <https://www.mfcr.cz/cs/aktualne/tiskove-zpravy/2020/ministryne-financi-reaguje-na-vyzvy-zast-38500>

Realistický scénář v podobně snížení rozpočtového určení daní o 20 % odvozujeme jak z existujících odhadů, tak z vlastních pracovních odhadů poklesu daňových příjmů (na základě publikovaných elasticit a pozorovaného poklesu daňových příjmů v roce 2009).

Také představujeme pesimistický scénář s poklesem o 30 % vzhledem k nejistotám spojeným s vývojem COVID-19 i ekonomiky. 

Dále zjednodušeně předpokládáme, že výdaje a ostatní příjmy budou stejné jako v roce 2019.^[To je sice spíše nerealistický předpoklad, protože obce budou výdaje snižovat, ale reálně to zřejmě znamená nižší výdaje, než obce rozpočtovaly na rok 2020.
Rozpočtové plány obcí na rok 2020 byly zveřejněny teprve velice nedávno, proto jako zástupné hodnoty pro baseline scénář využíváme právě skutečné výdaje z roku 2019. V další verzi výchozí scénář zpřesníme pomocí čerstvějších dat.]

#### Rozhodování obcí ohledně dluhu a rezerv

Pro odhad budoucího zadlužení obcí (a tím i jejich plnění pravidla rozpočtové odpovědnosti) je třeba uvažovat i o tom, jak se obce rozhodnou financovat své deficity: zda budou vyčerpávat rezervy, zadlužovat se, nebo tyto zdroje kombinovat. 

Pro názornost a uchopitelnost výpočtů uvažujeme dvě (extrémní) varianty: scénář, kdy obec veškerý deficit financuje zadlužením, a opačný scénář, kdy čerpá rezervy, popř. využívá jiné zdroje.

Kvůli přehlednosti tyto dvě varianty zvažujeme pouze u realistického (středního) scénáře poklesu příjmů z RUD.

### Sledované aspekty finanční kondice obcí

Sledujeme dopad změn obsažených v těchto scénářích na tyto základní aspekty finančního zdraví obcí:

- příjmy
- bilanci rozpočtů
- dluh a rozpočtovou odpovědnost (podle MF ČR)
- stav rezerv

U těchto indikátorů nás zajímají 

- počty a podíly obcí, které se překročí významný práh indikátoru (např. propad do deficitu, překročení hranice ukazatele rozpočtové odpovědnosti)
- rozložení těchto dopadů mezi kraje a velikostní a funkční skupiny obcí
- agregátní dopady na celý "obecní sektor", tj. např. o kolik klesne úhrn daňových příjmů obcí

## **Realistický** {.tabset}

```{r scen-subsets}
scto <- c(sc_real_mid, sc_base) 
scta <- c(sc_real, sc_base) 
```


### Příjmy {.tabset .tabset-pills .tabset-fade}

```{r num-rud}
rud <- sum(indik_2019$rozp_p_rud/1e9)
rud_share <- rud/sum(indik_2019$rozp_p_celkem/1e9)
```

#### Typy obcí

```{r diff-fun}
scen_diffs_abs <- function(data, scens, var, grpvar) {
  dto <- data %>% 
    filter(scenario %in% {{scens}}, per_yr == 2020) %>% 
    select(ico, orgs_ucjed_nazev, scenario, {{grpvar}},
           per_yr, {{var}}) %>% 
    spread(scenario, {{var}}) %>% 
    select(orgs_ucjed_nazev, R0, matches("^R[1-3]"),
           grp = {{grpvar}}) %>% 
    mutate_at(vars(matches("^R[1-3]")),
              list(abs = ~.-R0, rel = ~(.-R0)/R0)) %>% 
    pivot_longer(cols = matches("abs$|rel$")) %>%
    select(-matches("^R[1-3]")) %>%
    filter(TRUE)
  
  # print(length(scens))
  
  scen_sim <- scens[str_detect(scens, "^R[1-3]")]
  
  if(length(scen_sim) == 1) {
    dto <- dto %>%
      mutate(scenario = scen_sim) %>%
      rename(change_type = name)
  } else {
    dto <- dto %>%
      separate(name, into = c("scenario", "change_type"),
               sep = "_")
  }
}

iscn_p_typ <- scen_diffs_abs(iscn, scto, rozp_p_celkem, typobce)
```


```{r r20-prijem-typ-bar, include=T, fig.asp=.4}
iscn_p_typ %>% 
  filter(change_type == "rel") %>%
  group_by(grp) %>% 
  summarise(value = mean(value)) %>% 
  ggplot() +
  geom_col(aes(-value, grp)) +
  theme_ptrr(multiplot = F, gridlines = "x") +
  # scale_y_percent_cz() +
  scale_x_percent_cz(expand = flush_axis) +
  labs(title = "Průměrný pokled obecních příjmů podle typu obce",
       subtitle = "Scénář: pokles RUD o 20 %")
```


```{r r20-prijem-typ-fillbar, include=T, fig.asp=.4}
iscn_p_typ %>% 
  filter(change_type == "rel") %>%
  mutate(value_grp = cut2(-value, cuts = seq(0, 0.2, .05),
                          formatfun = label_percent_cz(1)) %>% 
           fct_rev()) %>% 
  ggplot() +
  geom_bar(aes(x = grp, fill = value_grp), position = "fill",
           colour = NA) +
  theme_ptrr(multiplot = F, gridlines = "y", legend.position = "bottom") +
  coord_flip() +
  scale_fill_brewer(direction = -1, palette = "Blues") +
  guides(fill = guide_legend(title = NULL, reverse = T)) +
  scale_y_percent_cz(expand = flush_axis) +
  labs(title = "Obce podle míry poklesu příjmů")
```

```{r prijmy-typy, include=T}
iscn_p_typ %>% 
  filter(change_type == "rel") %>%
  mutate(value_grp = cut_interval(value, length = .05)) %>% 
  ggplot() +
  geom_histogram(aes(value, y = stat(width * density)),
                 fill = "darkblue") +
  facet_wrap(~grp) +
  theme_ptrr(multiplot = T, gridlines = "both") +
  scale_y_percent_cz() +
  scale_x_percent_cz() +
  labs(title = "Rozdělení obcí podle poklesu příjmů",
       subtitle = "Scénář: pokles RUD o 20 %")
```


#### Kraje

```{r prijmy-kraje-data}
iscn_p_kraj <- scen_diffs_abs(iscn, scto, rozp_p_celkem, kraj_short)
```


```{r r20-prijem-kraj-bar, include=T, fig.asp=.5}
iscn_p_kraj %>% 
  filter(change_type == "rel") %>%
  group_by(grp) %>% 
  summarise(value = mean(value)) %>% 
  ggplot() +
  geom_col(aes(-value, grp %>% fct_reorder(-value))) +
  theme_ptrr(multiplot = F, gridlines = "x") +
  # scale_y_percent_cz() +
  scale_x_percent_cz(expand = flush_axis) +
  labs(title = "Průměrný pokles obecních příjmů podle kraje",
       subtitle = "Scénář: pokles RUD o 20 %")
```

```{r r20-prijem-kraje-hist, include=T}
iscn_p_kraj %>% 
  filter(change_type == "rel",
         grp != "Praha") %>%
  mutate(value_grp = cut_interval(value, length = .05),
         grp = fct_reorder(grp, value, "mean")) %>% 
  ggplot() +
  geom_histogram(aes(value, y = stat(width * density)),
                 fill = "darkblue") +
  facet_wrap(~grp) +
  theme_ptrr(multiplot = T, gridlines = "both") +
  scale_y_percent_cz() +
  scale_x_percent_cz() +
  labs(title = "Rozdělení obcí podle poklesu příjmů",
       subtitle = "Podle krajů; scénář: pokles RUD o 20 %")
```



#### Velikosti obcí

```{r prijmy-vel-data}
iscn_p_vel <- scen_diffs_abs(iscn, scto, rozp_p_celkem, katobyv_nazev)
```

```{r r20-prijem-vel-bar, include=T, fig.asp=.5}
iscn_p_vel %>% 
  filter(change_type == "rel") %>%
  group_by(grp) %>% 
  summarise(value = mean(value)) %>% 
  ggplot() +
  geom_col(aes(-value, grp)) +
  theme_ptrr(multiplot = F, gridlines = "x") +
  # scale_y_percent_cz() +
  scale_x_percent_cz(expand = flush_axis) +
  labs(title = "Průměrný pokles obecních příjmů podle počtu obyvatel",
       subtitle = "Scénář: pokles RUD o 20 %")
```

```{r r20-prijem-vel-hist, include=T}
iscn_p_vel %>% 
  filter(change_type == "rel",
         grp != "nad 1 000 000") %>%
  mutate(value_grp = cut_interval(value, length = .05)) %>% 
  ggplot() +
  geom_histogram(aes(value, y = stat(width * density)),
                 fill = "darkblue") +
  facet_wrap(~grp) +
  theme_ptrr(multiplot = T, gridlines = "both") +
  scale_y_percent_cz() +
  scale_x_percent_cz() +
  labs(title = "Rozdělení obcí podle poklesu příjmů",
       subtitle = "Scénář: pokles RUD o 20 %")

```

#### Celkem

```{r prijmy-celkem}
iscn %>% 
  filter(scenario %in% scto, per_yr == 2020) %>% 
  count(per_yr, scenario, wt = rozp_p_celkem, name = "outcome") %>%
  spread(scenario, outcome) %>% 
  mutate_at(vars(matches("^R[1-3]")), ~.-R0) %>% 
  # select(-R0) %>% 
  gather("scenario", "value", -per_yr, -R0)

```


### Bilance rozpočtů {.tabset .tabset-pills .tabset-fade}

```{r bilance-diff}
iscn_bil_diffs <- iscn %>% 
  filter(scenario %in% scto) %>% 
  left_join(iscn %>% 
              filter(scenario == "R0") %>% 
              select(ico, bilance_rel, bilance) %>% 
              rename(bilance_rel_base = bilance_rel,
                     bilance_base = bilance)) %>% 
  mutate(bilance_rel_diff = bilance_rel - bilance_rel_base,
         bilance_diff = bilance_base,
         was_negative = bilance_rel_base < 0,
         is_negative = bilance_rel < 0,
         newly_negative = !was_negative & is_negative)
```

#### Typy obcí

```{r r20-bil-typ-bar, include=T, fig.asp=0.4}
iscn_bil_diffs %>% 
  ungroup() %>% 
  mutate(grp = typobce) %>% 
  count(grp, wt = sum(newly_negative)/n()) %>% 
  mutate(var = "Obce, které spadnou do deficitu ve scénáři 2020") %>% 
  bind_rows(iscn_bil_diffs %>% 
              mutate(grp = typobce) %>% 
              ungroup() %>% 
              count(grp, wt = sum(was_negative)/n()) %>% 
              mutate(var = "Obce, které měly deficit v roce 2019")) %>% 
  ggplot(aes(n, grp %>% fct_reorder(n), fill = var %>% 
               fct_rev())) +
  geom_col() +
  scale_x_percent_cz() +
  scale_fill_manual(values = c("Obce, které měly deficit v roce 2019" = "grey", 
                                "Obce, které spadnou do deficitu ve scénáři 2020" = "darkblue"), 
                     name = NULL) +
  guides(fill = guide_legend(reverse = T)) +
  theme_ptrr("x", legend.position = "bottom") +
  labs(title = "Podíl obcí, které se propadnou do deficitu",
       subtitle = "Podle typu obce, scénář poklesu RUD o 20 %")
```


```{r r20-bil-typ-hist, include=T}
iscn %>% 
  filter(scenario %in% scto, per_yr == 2020) %>% 
  filter(bilance_rel < 1) %>%
  mutate(scenario = recode(scenario, 
                           R0 = "2019", "R20-D0-mix" = "Scénář 2020")) %>% 
  ggplot(aes(bilance_rel)) +
  # geom_histogram(aes(fill = scenario, y = stat(width * density),
  #                    alpha = scenario), colour = NA, position = "identity") +
  geom_density(aes(fill = scenario, alpha = scenario), colour = NA) +
  scale_fill_manual(values = c(`2019` = "grey", 
                               `Scénář 2020` = "darkblue"), name = NULL) +
  geom_vline(xintercept = 0) +
  scale_alpha_manual(values = c(`2019` = 1, `Scénář 2020` = 0.6), name = NULL) +
  facet_wrap(~typobce) +
  scale_x_percent_cz() +
  # scale_y_percent_cz() +
  theme_ptrr(multiplot = T, gridlines = "both", legend.position = "bottom") +
  labs(title = "Rozložení bilance obcí, 2019 a scénář 2020", 
       subtitle = "Scénář 2020 = 20 % pokles RUD.\nObce s bilancí nad +100 % vynechány")
```

#### Kraje


```{r r20-bil-kraj-bar, include=T, fig.asp = .5}
iscn_bil_diffs %>% 
  ungroup() %>% 
  mutate(grp = kraj_short) %>% 
  count(grp, wt = sum(newly_negative)/n()) %>% 
  mutate(var = "Obce, které se propadnou do deficitu ve scénáři 2020") %>% 
  bind_rows(iscn_bil_diffs %>% 
              mutate(grp = kraj_short) %>% 
              ungroup() %>% 
              count(grp, wt = sum(was_negative)/n()) %>% 
              mutate(var = "Obce, které měly deficit v roce 2019")) %>% 
  ggplot(aes(n, grp %>% fct_reorder(n),
             fill = var %>% fct_rev())) +
  geom_col() +
  scale_x_percent_cz(expand = flush_axis) +
  scale_fill_manual(values = c("Obce, které měly deficit v roce 2019" = "grey", 
                                "Obce, které se propadnou do deficitu ve scénáři 2020" = "darkblue"), 
                     name = NULL) +
  guides(fill = guide_legend(reverse = T)) +
  theme_ptrr("x") +
  theme(legend.position = "bottom") +
  labs(title = "Podíl obcí s deficitním rozpočtem, 2019 a scénář 2020",
       subtitle = "Podle kraje, scénář poklesu RUD o 20 %")
```

```{r r20-bil-kraj-hist, include=T}
iscn %>% 
  filter(scenario %in% scto, per_yr == 2020) %>% 
  filter(kraj_short != "Praha", bilance_rel < 1) %>% 
  mutate(scenario = recode(scenario, R0 = "2019", 
                           "R20-D0-mix" = "Scénář 2020")) %>% 
  ggplot(aes(bilance_rel)) +
  # geom_histogram(aes(fill = scenario, y = stat(width * density),
  #                    alpha = scenario), colour = NA, position = "identity") +
  geom_density(aes(fill = scenario, alpha = scenario), colour = NA) +
  scale_fill_manual(values = c(`2019` = "grey", 
                               `Scénář 2020` = "darkblue"), name = NULL) +
  geom_vline(xintercept = 0) +
  scale_alpha_manual(values = c(`2019` = 1, `Scénář 2020` = 0.6), name = NULL) +
  facet_wrap(~kraj_short) +
  scale_x_percent_cz() +
  # scale_y_percent_cz() +
  theme_ptrr(multiplot = T, gridlines = "both", legend.position = "bottom") +
  labs(title = "Rozložení bilance obcí, 2019 a scénář 2020", 
       subtitle = "Scénář 2020 = 20 % pokles RUD.\nObce s bilancí nad +100 % vynechány")
```



#### Velikost obcí

```{r r20-bil-vel-bar, include=T, fig.asp=0.5}
iscn_bil_diffs %>% 
  ungroup() %>% 
  mutate(grp = katobyv_nazev) %>% 
  count(grp, wt = sum(newly_negative)/n()) %>% 
  mutate(var = "Obce, které se propadnou do deficitu ve scénáři 2020") %>% 
  bind_rows(iscn_bil_diffs %>% 
              mutate(grp = katobyv_nazev) %>% 
              ungroup() %>% 
              count(grp, wt = sum(was_negative)/n()) %>% 
              mutate(var = "Obce, které měly deficit v roce 2019")) %>% 
  ggplot(aes(n, grp, fill = var %>% fct_rev())) +
  geom_col() +
  scale_x_percent_cz(expand = flush_axis) +
  scale_fill_manual(values = c("Obce, které měly deficit v roce 2019" = "grey", 
                               "Obce, které se propadnou do deficitu ve scénáři 2020" = "darkblue"), 
                     name = NULL) +
  guides(fill = guide_legend(reverse = T)) +
  theme_ptrr("x") +
  theme(legend.position = "bottom") +
  labs(title = "Podíl obcí s deficitním rozpočtem, 2019 a scénář 2020",
       subtitle = "Podle počtu obyvatel, scénář poklesu RUD o 20 %")
```

#### Celkem

### Zadluženost a rozpočtová odpovědnost {.tabset .tabset-pills .tabset-fade}



### Stav finančních rezerv {.tabset .tabset-pills .tabset-fade}


## Optimistický

## Pesimistický

### OLD

Pokud by příjmy z rozpočtového určení daní klesly v roce 2020 o 10 %, zvednul by se počet obcí s deficitním rozpočtem, a tedy s vyššími výdaji než příjmy o 9,6 p.b. oproti roku 2019, resp. by tento podíl narostl o třetinu (z 1697 obcí v roce 2019 na 2296 obcí v roce 2020). V případě poklesu o 20 % nebo 30 % by se počet těchto obcí zvýšil o 20 %, resp. 30 %. 
